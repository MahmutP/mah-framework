from core.module import BaseModule
from core.option import Option
from typing import Dict, Any
import importlib
import sys

class MultiHandler(BaseModule):
    """
    Genel Payload Handler Modülü (exploit/multi/handler).
    Farklı payload türleri için dinleyici başlatır.
    """
    Name = "exploit/multi/handler"
    Description = "Genel payload dinleyici (handler)."
    Author = "Mahmut P."
    Category = "exploit"

    def __init__(self):
        super().__init__()
        self.Options = {
            "PAYLOAD": Option("PAYLOAD", "python/shell_reverse_tcp", True, "Dinlenecek payload türü."),
            "LHOST": Option("LHOST", "0.0.0.0", True, "Dinlenecek yerel IP adresi."),
            "LPORT": Option("LPORT", 4444, True, "Dinlenecek yerel Port."),
            "RHOST": Option("RHOST", "127.0.0.1", False, "Bağlanılacak Hedef IP (Bind Shell için).")
        }
        self.current_handler = None
        self._update_payload_choices()

    def _update_payload_choices(self):
        """PAYLOAD seçeneği için mevcut payloadları yükler."""
        from core.shared_state import shared_state
        if shared_state.module_manager:
            all_modules = shared_state.module_manager.get_all_modules().keys()
            # Sadece 'payloads/' ile başlayan modülleri al
            payload_choices = [m for m in all_modules if m.startswith("payloads/")]
            # Seçeneklere ekle (Prefix olan 'payloads/' kısmını atarak daha temiz görünmesini isterseniz: m.replace("payloads/", ""))
            # Ancak kullanıcı tam yol girmeli, o yüzden olduğu gibi bırakıyoruz.
            
            # Seçeneklerin "choices" özelliğini güncelle
            self.Options["PAYLOAD"].choices = sorted(payload_choices)

    def run(self, options: Dict[str, Any]):
        payload_name_raw = options.get("PAYLOAD")
        lhost = options.get("LHOST")
        lport = int(options.get("LPORT"))

        print(f"[*] Handler başlatılıyor: {payload_name_raw} -> {lhost}:{lport}")
        
        # Payload yolu bazen "payloads/..." şeklinde gelebilir, bazen "modules/payloads/..."
        # Bizim module manager'daki key yapımız genelde "payloads/..." şeklindedir.
        # Handler dosyasını bulmak için path manipülasyonu yapıyoruz.
        
        # Örn: payloads/python/mahpreter/reverse_tcp/generate -> modules.payloads.python.mahpreter.reverse_tcp.handler
        
        try:
            # 1. Path temizliği
            base_module_path = payload_name_raw
            
            # "generate" suffix'ini at (eğer varsa)
            if base_module_path.endswith("/generate"):
                 base_module_path = base_module_path.replace("/generate", "")
            
            # Olası dublike "payloads/" veya yanlış prefixleri temizle
            # Kullanıcı yanlışlıkla "payloads/payloads/..." yazmış olabilir.
            while "//" in base_module_path:
                base_module_path = base_module_path.replace("//", "/")
            
            if base_module_path.startswith("payloads/payloads/"):
                base_module_path = base_module_path.replace("payloads/payloads/", "payloads/")

            if base_module_path.startswith("modules/"):
                base_module_path = base_module_path.replace("modules/", "")
            
            # 2. Path'i nokta notasyonuna çevir ve "modules." prefix'i ekle
            module_import_path = "modules." + base_module_path.replace("/", ".") + ".handler"
            
            print(f"[*] Handler modülü yükleniyor: {module_import_path}")
            
            # 3. Dinamik import
            handler_module = importlib.import_module(module_import_path)
            
            # 4. Handler sınıfını al
            HandlerClass = getattr(handler_module, "Handler")
            
            # 5. Handler'ı başlat
            handler_instance = HandlerClass(options)
            self.current_handler = handler_instance
            handler_instance.start()
            
            return True
            
        except ImportError:
            print(f"[!] Bu payload için özel bir 'handler.py' bulunamadı: {module_import_path}")
            print("[*] Lütfen bu payload için henüz handler desteği olmadığını not edin.")
            return False
        except AttributeError:
             print(f"[!] '{module_import_path}' içinde 'Handler' sınıfı bulunamadı.")
             return False
        except Exception as e:
            print(f"[!] Handler başlatılamadı: {e}")
            return False
